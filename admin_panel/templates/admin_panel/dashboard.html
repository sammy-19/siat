{% extends 'admin_panel/base.html' %}
{% block title %}Admin Dashboard{% endblock %}
{% block header_title %}Welcome to SIAT Admin CMS{% endblock %}
{% block content %}
<section class="py-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Students vs Instructors</h5>
                </div>
                <div class="card-body">
                    <canvas id="userChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Students per Subject</h5>
                </div>
                <div class="card-body">
                    <canvas id="subjectChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <h3>Student Overview</h3>
    <div class="row">
        {% for student in students %}
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5>{{ student.full_name }}</h5>
                    <p>Email: {{ student.email }}</p>
                    <p>Student Number: {{ student.student_number }}</p>
                    <p>Courses: 
                    {% for enrollment in student.enrollment_set.all %}
                        {{ enrollment.course.title }} ({{ enrollment.progress }}%)
                        {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                    </p>
                    <div class="progress">
                    {% for enrollment in student.enrollment_set.all %}
                        <div class="progress-bar" role="progressbar" 
                            style="width: {{ enrollment.progress }}%;" 
                            aria-valuenow="{{ enrollment.progress }}" aria-valuemin="0" aria-valuemax="100">
                            {{ enrollment.progress }}%
                        </div>
                    {% empty %}
                        <span>No course enrollment yet.</span>
                    {% endfor %}
                    </div>
                </div>
                <a href="{% url 'admin_panel:edit_student' student.pk %}" class="btn btn-sm btn-warning">Edit</a>
            </div>
        </div>
        {% empty %}
        <p class="alert alert-danger">No students registered yet.</p>
        {% endfor %}
        <a href="{% url 'admin_panel:manage_students' %}" class="btn btn-link mt-2">See all students</a>
    </div>

    <h3 class="mt-5">Instructor Overview</h3>
    <div class="row">
        {% for instructor in instructors %}
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5>{{ instructor.full_name }}</h5>
                    <p>Email: {{ instructor.email }}</p>
                    <p>Courses: {% for course in instructor.courses_taught.all %}{{ course.title }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                </div>
                <a href="{% url 'admin_panel:edit_instructor' instructor.pk %}" class="btn btn-sm btn-warning">Edit</a>
            </div>
        </div>
        {% empty %}
        <p class="alert alert-danger">No instructors registered yet.</p>
        {% endfor %}
        <a href="{% url 'admin_panel:manage_instructors' %}" class="btn btn-link mt-2">See all instructors</a>
    </div>

    <h3 class="mt-5">CMS Content Overview</h3>
    <div class="row">
        {% for section in about_sections %}
        <div class="col-md-12 mb-3">
            <div class="card">
                <div class="card-body">
                    <h5>{{ section.title }}</h5>
                    <p>{{ section.content|truncatewords:20 }}</p>
                    <a href="{% url 'admin_panel:edit_about_section' section.pk %}" class="btn btn-primary">Edit</a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <h3 class="mt-5">Portal Settings</h3>
    <div class="card">
        <div class="card-body">
            <p>Student Portal Active: {{ settings.student_portal_active|yesno:"Yes,No" }}</p>
            <p>Instructor Portal Active: {{ settings.instructor_portal_active|yesno:"Yes,No" }}</p>
            <p>Maintenance Message: {{ settings.maintenance_message|default:"None" }}</p>
            <a href="{% url 'admin_panel:portal_settings' %}" class="btn btn-primary">Edit Settings</a>
        </div>
    </div>
</section>
<meta name="description" content="{{ meta_description }}">
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const totalStudents = {{ total_students }};
    const totalInstructors = {{ total_instructors }};
    
    const userCtx = document.getElementById('userChart').getContext('2d');
    new Chart(userCtx, {
        type: 'bar',
        data: {
            labels: ['Students', 'Instructors'],
            datasets: [{
                label: 'Total Count',
                data: [totalStudents, totalInstructors],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Total Count',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'User Type',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
    
    const subjectLabels = {{ subject_labels|safe }};
    const studentsPerSubject = {{ students_per_subject|safe }};
    
    const subjectCtx = document.getElementById('subjectChart').getContext('2d');
    new Chart(subjectCtx, {
        type: 'bar',
        data: {
            labels: subjectLabels,
            datasets: [{
                label: 'Number of Students',
                data: studentsPerSubject,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Students',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Subject Code',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}